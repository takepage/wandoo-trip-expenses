<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„ì§œë°°ê¸° ì—¬í–‰ ê²½ë¹„</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        
        /* ì›Œí„°íŒŒí¬ í…Œë§ˆ CSS */
        .water-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .water-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .water-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .water-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* ë¬¼ë°©ìš¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes bubble {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-20px) scale(1.1); opacity: 0; }
        }
        
        .bubble {
            animation: bubble 2s infinite;
        }
        
        /* ì´ìŠ¤í„°ì—ê·¸ ìŠ¤íƒ€ì¼ */
        .easter-egg {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .easter-egg:hover {
            transform: scale(1.05);
        }
        
        /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
        .mobile-button {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Plus, Check, MoreVertical, Edit3, Trash2, Users, AlertCircle, Wifi, ChevronDown, ChevronUp, Waves, Droplets } = lucide;

        // ğŸ”¥ Firebase ì„¤ì • (ë” ì•ˆì „í•œ ë²„ì „)
        const firebaseConfig = {
            apiKey: "AIzaSyBn2VFGn7dQHaXCrWOeVhtQFRSd9wjPMao",
            authDomain: "wandoo-trip-expenses.firebaseapp.com",
            databaseURL: "https://wandoo-trip-expenses-default-rtdb.firebaseio.com",
            projectId: "wandoo-trip-expenses",
            storageBucket: "wandoo-trip-expenses.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Firebase ì´ˆê¸°í™” ì•ˆì „ì„± ê²€ì‚¬
        let database;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ');
        } catch (error) {
            console.error('âŒ Firebase ì—°ê²° ì‹¤íŒ¨:', error);
            // Firebase ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘
            database = null;
        }

        // ğŸŠâ€â™€ï¸ ìƒˆë¡œìš´ ì—¬í–‰ ë©¤ë²„ (6ëª…)
        const members = ['íƒœì›…', 'ì¬ì›', 'ì¬í—Œ', 'ìŠ¹ìš°', 'íƒœí˜¸', 'ì§„í˜•'];
        
        const categories = [
            { id: 'transport', name: 'êµí†µë¹„', icon: 'ğŸš—', color: 'bg-blue-100 text-blue-800' },
            { id: 'accommodation', name: 'ìˆ™ë°•ë¹„', icon: 'ğŸ ', color: 'bg-green-100 text-green-800' },
            { id: 'food', name: 'ì‹ë¹„', icon: 'ğŸ–', color: 'bg-orange-100 text-orange-800' },
            { id: 'activity', name: 'í™œë™ë¹„', icon: 'ğŸŠâ€â™€ï¸', color: 'bg-purple-100 text-purple-800' },
            { id: 'other', name: 'ê¸°íƒ€', icon: 'ğŸ’¦', color: 'bg-gray-100 text-gray-800' }
        ];

        function App() {
            // ìƒíƒœ ê´€ë¦¬
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [connected, setConnected] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [expandedExpenses, setExpandedExpenses] = useState({});
            const [showExpenseMenu, setShowExpenseMenu] = useState({});
            
            // ğŸ–ï¸ ì´ìŠ¤í„°ì—ê·¸ ìƒíƒœ
            const [clickCount, setClickCount] = useState(0);
            const [showEasterEgg, setShowEasterEgg] = useState(false);
            const [easterEggMessage, setEasterEggMessage] = useState('');

            // í¼ ìƒíƒœ
            const [formData, setFormData] = useState({
                title: '',
                amount: '',
                payer: members[0],
                participants: [...members],
                category: 'food',
                splitType: 'equal',
                customSplit: {},
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            });

            // ğŸ”¥ Firebase ì—°ê²° ë° ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” (ì•ˆì „ ë²„ì „)
            useEffect(() => {
                console.log('ğŸ”¥ Firebase ì—°ê²° ì‹œì‘...');
                
                // Firebaseê°€ ì—†ìœ¼ë©´ ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘
                if (!database) {
                    console.log('âš ï¸ Firebase ì—°ê²° ë¶ˆê°€, ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘');
                    setConnected(false);
                    setLoading(false);
                    return;
                }

                try {
                    const expensesRef = database.ref('expenses');
                    
                    // ì—°ê²° ìƒíƒœ í™•ì¸
                    const connectedRef = database.ref('.info/connected');
                    connectedRef.on('value', (snapshot) => {
                        const isConnected = snapshot.val() === true;
                        console.log('ğŸŒŠ ì—°ê²° ìƒíƒœ:', isConnected);
                        setConnected(isConnected);
                    });

                    // ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
                    expensesRef.on('value', (snapshot) => {
                        console.log('ğŸ“Š ë°ì´í„° ìˆ˜ì‹ :', snapshot.val());
                        const data = snapshot.val();
                        if (data) {
                            const expensesList = Object.keys(data).map(key => {
                                const expense = data[key];
                                return {
                                    ...expense,
                                    id: key,
                                    participants: expense.participants || [],
                                    completedBy: expense.completedBy || {},
                                    customSplit: expense.customSplit || {},
                                    amount: expense.amount || 0,
                                    payer: expense.payer || '',
                                    title: expense.title || '',
                                    category: expense.category || 'other',
                                    date: expense.date || new Date().toISOString().split('T')[0],
                                    time: expense.time || '00:00'
                                };
                            });
                            setExpenses(expensesList);
                            console.log('âœ… ê²½ë¹„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', expensesList.length, 'ê°œ');
                        } else {
                            setExpenses([]);
                            console.log('ğŸ“ ê²½ë¹„ ë°ì´í„° ì—†ìŒ');
                        }
                        setLoading(false);
                    });

                    // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ í›„ ê°•ì œ ë¡œë”© ì™„ë£Œ)
                    const timeout = setTimeout(() => {
                        console.log('â° ë¡œë”© íƒ€ì„ì•„ì›ƒ, ê°•ì œ ì™„ë£Œ');
                        setLoading(false);
                    }, 10000);

                    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ë¦¬ìŠ¤ë„ˆ í•´ì œ
                    return () => {
                        console.log('ğŸ”„ Firebase ë¦¬ìŠ¤ë„ˆ í•´ì œ');
                        clearTimeout(timeout);
                        expensesRef.off();
                        connectedRef.off();
                    };
                } catch (error) {
                    console.error('âŒ Firebase ì—°ê²° ì¤‘ ì—ëŸ¬:', error);
                    setConnected(false);
                    setLoading(false);
                }
            }, []);

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
            useEffect(() => {
                const handleClickOutside = () => {
                    setShowExpenseMenu({});
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            // ğŸ–ï¸ ì´ìŠ¤í„°ì—ê·¸ ë¡œì§
            const handleTitleClick = () => {
                const newCount = clickCount + 1;
                setClickCount(newCount);
                
                if (newCount === 3) {
                    setShowEasterEgg(true);
                    setEasterEggMessage('ğŸ–ï¸ ìŠ¹ìš° ì…ëŒ€ëŒ€ê¸°ë°© ğŸ–ï¸');
                } else if (newCount === 5) {
                    setEasterEggMessage('ğŸ“… D-day: 9ì›” ì…ëŒ€ ì˜ˆì •! ğŸ’ª');
                } else if (newCount === 7) {
                    setEasterEggMessage('ğŸ«¡ ë§ˆì§€ë§‰ ììœ ì—¬í–‰ì„ ì¦ê²¨ë¼! ğŸŠâ€â™€ï¸');
                    setTimeout(() => {
                        setShowEasterEgg(false);
                        setClickCount(0);
                    }, 3000);
                }
            };

            // Firebase ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì•ˆì „ ë²„ì „)
            const updateExpenseInFirebase = (expenseId, updates) => {
                if (!database) {
                    console.log('âš ï¸ Firebase ì—°ê²° ì—†ìŒ, ì—…ë°ì´íŠ¸ ë¶ˆê°€');
                    alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.');
                    return;
                }
                try {
                    console.log('ğŸ”„ Firebase ì—…ë°ì´íŠ¸:', { expenseId, updates });
                    database.ref(`expenses/${expenseId}`).update(updates);
                } catch (error) {
                    console.error('Firebase ì—…ë°ì´íŠ¸ ì—ëŸ¬:', error);
                    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const deleteExpenseFromFirebase = (expenseId) => {
                if (!database) {
                    console.log('âš ï¸ Firebase ì—°ê²° ì—†ìŒ, ì‚­ì œ ë¶ˆê°€');
                    alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.');
                    return;
                }
                try {
                    console.log('ğŸ—‘ï¸ Firebase ì‚­ì œ:', expenseId);
                    database.ref(`expenses/${expenseId}`).remove();
                } catch (error) {
                    console.error('Firebase ì‚­ì œ ì—ëŸ¬:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            const addExpenseToFirebase = (expenseData) => {
                if (!database) {
                    console.log('âš ï¸ Firebase ì—°ê²° ì—†ìŒ, ì¶”ê°€ ë¶ˆê°€');
                    alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.');
                    return null;
                }
                try {
                    console.log('â• Firebase ì¶”ê°€:', expenseData);
                    const newExpenseRef = database.ref('expenses').push();
                    newExpenseRef.set({
                        ...expenseData,
                        createdAt: Date.now(),
                        completedBy: {}
                    });
                    return newExpenseRef.key;
                } catch (error) {
                    console.error('Firebase ì¶”ê°€ ì—ëŸ¬:', error);
                    alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return null;
                }
            };

            // ì •ì‚° ê´€ë ¨ í•¨ìˆ˜ë“¤
            const togglePersonalCompletion = (expenseId, member) => {
                try {
                    console.log('ê°œì¸ ì •ì‚° ì‹œì‘:', { expenseId, member });
                    
                    const expense = expenses.find(e => e && e.id === expenseId);
                    if (!expense) {
                        console.error('ê²½ë¹„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', expenseId);
                        alert('ê²½ë¹„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    if (!member || typeof member !== 'string') {
                        console.error('ì˜ëª»ëœ ë©¤ë²„ ì´ë¦„:', member);
                        alert('ë©¤ë²„ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const memberAmount = getParticipantAmount(expense, member);
                    console.log('ë©¤ë²„ ê¸ˆì•¡:', memberAmount);
                    
                    const userConfirm = window.confirm(`${member}ë‹˜ì˜ ${memberAmount.toLocaleString()}ì› ì •ì‚°ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    
                    if (userConfirm) {
                        const currentCompletedBy = expense.completedBy && typeof expense.completedBy === 'object' ? {...expense.completedBy} : {};
                        const currentStatus = currentCompletedBy[member] === true;
                        
                        currentCompletedBy[member] = !currentStatus;
                        
                        console.log('ì •ì‚° ìƒíƒœ ì—…ë°ì´íŠ¸:', { 
                            expenseId, 
                            member, 
                            currentStatus, 
                            newStatus: !currentStatus,
                            newCompletedBy: currentCompletedBy
                        });
                        
                        updateExpenseInFirebase(expenseId, { completedBy: currentCompletedBy });
                    }
                    
                } catch (error) {
                    console.error('ê°œì¸ ì •ì‚° ì²˜ë¦¬ ì—ëŸ¬:', error);
                    alert('ì •ì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            };

            const toggleExpenseCompletion = (expenseId) => {
                const expense = expenses.find(e => e && e.id === expenseId);
                if (!expense) {
                    alert('ê²½ë¹„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const isCompleted = isExpenseCompleted(expense);
                
                const message = isCompleted 
                    ? `"${expense.title}" í•­ëª©ì˜ ì „ì²´ ì •ì‚°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                    : `"${expense.title}" í•­ëª©ì˜ ì „ì²´ ì •ì‚°ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                
                const userConfirm = window.confirm(message);
                
                if (userConfirm) {
                    try {
                        let newCompletedBy = {};
                        if (!isCompleted && expense.participants) {
                            expense.participants.forEach(participant => {
                                newCompletedBy[participant] = true;
                            });
                        }
                        
                        console.log('ì „ì²´ ì •ì‚° ìƒíƒœ ì—…ë°ì´íŠ¸:', { 
                            expenseId, 
                            isCompleted, 
                            newCompletedBy 
                        });
                        
                        updateExpenseInFirebase(expenseId, { completedBy: newCompletedBy });
                        
                    } catch (error) {
                        console.error('ì „ì²´ ì •ì‚° ì²˜ë¦¬ ì—ëŸ¬:', error);
                        alert('ì •ì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                }
            };

            const deleteExpense = (expenseId, title) => {
                const userConfirm = window.confirm(`"${title}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                
                if (userConfirm) {
                    try {
                        console.log('ê²½ë¹„ ì‚­ì œ:', { expenseId, title });
                        deleteExpenseFromFirebase(expenseId);
                        setShowExpenseMenu({});
                    } catch (error) {
                        console.error('ì‚­ì œ ì²˜ë¦¬ ì—ëŸ¬:', error);
                        alert('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                }
            };

            const isExpenseCompleted = (expense) => {
                try {
                    if (!expense || typeof expense !== 'object') {
                        return false;
                    }
                    
                    const participants = expense.participants;
                    if (!Array.isArray(participants) || participants.length === 0) {
                        return false;
                    }
                    
                    const completedBy = expense.completedBy;
                    if (!completedBy || typeof completedBy !== 'object') {
                        return false;
                    }
                    
                    return participants.every(participant => {
                        if (!participant || typeof participant !== 'string') {
                            return false;
                        }
                        return completedBy[participant] === true;
                    });
                } catch (error) {
                    console.error('isExpenseCompleted ì—ëŸ¬:', error);
                    return false;
                }
            };

            const getParticipantAmount = (expense, member) => {
                try {
                    if (!expense || typeof expense !== 'object' || !member || typeof member !== 'string') {
                        return 0;
                    }
                    
                    const participants = expense.participants;
                    if (!Array.isArray(participants) || !participants.includes(member)) {
                        return 0;
                    }
                    
                    const customSplit = expense.customSplit && typeof expense.customSplit === 'object' ? expense.customSplit : {};
                    
                    if (expense.splitType === 'custom' && customSplit[member] && typeof customSplit[member] === 'number') {
                        return customSplit[member];
                    }
                    
                    const totalAmount = typeof expense.amount === 'number' ? expense.amount : 0;
                    const customTotal = Object.values(customSplit).reduce((sum, val) => {
                        return sum + (typeof val === 'number' ? val : 0);
                    }, 0);
                    
                    const remainingAmount = totalAmount - customTotal;
                    const remainingParticipants = participants.filter(p => 
                        p && typeof p === 'string' && !customSplit[p]
                    );
                    
                    return remainingParticipants.length > 0 ? Math.round(remainingAmount / remainingParticipants.length) : 0;
                } catch (error) {
                    console.error('getParticipantAmount ì—ëŸ¬:', error, { expense, member });
                    return 0;
                }
            };

            const calculatePersonalExpenses = () => {
                try {
                    const personalTotals = {};
                    
                    if (!Array.isArray(members)) {
                        console.error('membersê°€ ë°°ì—´ì´ ì•„ë‹˜');
                        return {};
                    }
                    
                    members.forEach(member => {
                        if (member && typeof member === 'string') {
                            personalTotals[member] = { paid: 0, owes: 0, net: 0 };
                        }
                    });

                    const activeExpenses = expenses.filter(expense => {
                        try {
                            return expense && typeof expense === 'object' && !isExpenseCompleted(expense);
                        } catch (error) {
                            console.error('activeExpenses í•„í„° ì—ëŸ¬:', error);
                            return false;
                        }
                    });

                    activeExpenses.forEach(expense => {
                        try {
                            if (!expense || typeof expense !== 'object') {
                                return;
                            }
                            
                            const payer = expense.payer;
                            if (payer && typeof payer === 'string' && personalTotals[payer]) {
                                const amount = typeof expense.amount === 'number' ? expense.amount : 0;
                                personalTotals[payer].paid += amount;
                            }
                            
                            const participants = expense.participants;
                            const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                            
                            if (Array.isArray(participants)) {
                                participants.forEach(participant => {
                                    try {
                                        if (participant && 
                                            typeof participant === 'string' && 
                                            personalTotals[participant] && 
                                            completedBy[participant] !== true) {
                                            
                                            const amount = getParticipantAmount(expense, participant);
                                            if (typeof amount === 'number' && amount >= 0) {
                                                personalTotals[participant].owes += amount;
                                            }
                                        }
                                    } catch (error) {
                                        console.error('participant ì²˜ë¦¬ ì—ëŸ¬:', error, { participant, expense });
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('expense ì²˜ë¦¬ ì—ëŸ¬:', error, expense);
                        }
                    });

                    Object.keys(personalTotals).forEach(member => {
                        try {
                            if (personalTotals[member] && typeof personalTotals[member] === 'object') {
                                const paid = personalTotals[member].paid || 0;
                                const owes = personalTotals[member].owes || 0;
                                personalTotals[member].net = paid - owes;
                            }
                        } catch (error) {
                            console.error('net ê³„ì‚° ì—ëŸ¬:', error, { member });
                        }
                    });

                    return personalTotals;
                } catch (error) {
                    console.error('calculatePersonalExpenses ì „ì²´ ì—ëŸ¬:', error);
                    const safeTotals = {};
                    members.forEach(member => {
                        if (member && typeof member === 'string') {
                            safeTotals[member] = { paid: 0, owes: 0, net: 0 };
                        }
                    });
                    return safeTotals;
                }
            };

            // ì´ ê²½ë¹„ ê³„ì‚°
            const totalExpenses = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const pendingExpenses = expenses.filter(expense => !isExpenseCompleted(expense))
                .reduce((sum, expense) => sum + (expense.amount || 0), 0);

            const personalTotals = calculatePersonalExpenses();

            // í¼ í•¸ë“¤ëŸ¬ë“¤
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.title.trim() || !formData.amount) {
                    alert('ì œëª©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const expenseData = {
                    ...formData,
                    amount: parseInt(formData.amount),
                    participants: [...formData.participants]
                };

                if (editingExpense) {
                    updateExpenseInFirebase(editingExpense.id, expenseData);
                } else {
                    addExpenseToFirebase(expenseData);
                }

                setShowAddForm(false);
                setEditingExpense(null);
                setFormData({
                    title: '',
                    amount: '',
                    payer: members[0],
                    participants: [...members],
                    category: 'food',
                    splitType: 'equal',
                    customSplit: {},
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().slice(0, 5)
                });
            };

            const startEdit = (expense) => {
                setEditingExpense(expense);
                setFormData({
                    title: expense.title,
                    amount: expense.amount.toString(),
                    payer: expense.payer,
                    participants: [...expense.participants],
                    category: expense.category,
                    splitType: expense.splitType || 'equal',
                    customSplit: expense.customSplit || {},
                    date: expense.date,
                    time: expense.time
                });
                setShowAddForm(true);
                setShowExpenseMenu({});
            };

            if (loading) {
                return React.createElement('div', { 
                    className: "min-h-screen water-theme flex items-center justify-center" 
                }, 
                    React.createElement('div', { className: "text-center text-white" }, [
                        React.createElement('div', { 
                            key: 'spinner',
                            className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-4" 
                        }),
                        React.createElement('p', { key: 'text' }, "ğŸŠâ€â™€ï¸ ì¼€ë¦¬ë¹„ì•ˆë² ì´ ë°ì´í„° ë¡œë”©ì¤‘..."),
                        React.createElement('p', { 
                            key: 'tip',
                            className: "text-xs text-white/70 mt-2" 
                        }, "10ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”"),
                        React.createElement('button', {
                            key: 'skip',
                            onClick: () => setLoading(false),
                            className: "mt-4 px-4 py-2 bg-white/20 rounded-lg text-white text-sm hover:bg-white/30"
                        }, "ë¡œë”© ê±´ë„ˆë›°ê¸°")
                    ])
                );
            }

            return React.createElement('div', { className: "min-h-screen bg-gray-50" }, [
                // ğŸŠâ€â™€ï¸ ì›Œí„°íŒŒí¬ í…Œë§ˆ í—¤ë”
                React.createElement('div', { 
                    key: 'header',
                    className: "water-theme shadow-lg sticky top-0 z-10" 
                }, 
                    React.createElement('div', { className: "px-4 py-4" }, [
                        React.createElement('div', { 
                            key: 'title',
                            className: "text-center" 
                        }, [
                            React.createElement('div', {
                                key: 'title-section',
                                className: "easter-egg",
                                onClick: handleTitleClick
                            }, [
                                React.createElement('h1', { 
                                    key: 'h1',
                                    className: "text-xl font-bold text-white drop-shadow-lg" 
                                }, "ğŸŠâ€â™€ï¸ ì§„ì§œë°°ê¸° ì—¬í–‰"),
                                React.createElement('p', { 
                                    key: 'subtitle',
                                    className: "text-sm text-white/90 font-medium" 
                                }, "7/24(ëª©) ~ 7/25(ê¸ˆ) â€¢ íœì…˜ â†’ ë°”ë² í â†’ ì¼€ë¦¬ë¹„ì•ˆë² ì´")
                            ]),
                            // ì—°ê²° ìƒíƒœ í‘œì‹œ
                            React.createElement('div', { 
                                key: 'status',
                                className: `flex items-center justify-center gap-1 mt-1 text-xs ${connected ? 'text-white/90' : 'text-red-200'}` 
                            }, [
                                React.createElement(Waves, { key: 'icon' }),
                                React.createElement('span', { key: 'text' }, connected ? 'ğŸŒŠ ì‹¤ì‹œê°„ ì—°ê²°ë¨' : 'âš ï¸ ì—°ê²° ëŠê¹€')
                            ])
                        ]),
                        React.createElement('div', { 
                            key: 'totals',
                            className: "mt-4 grid grid-cols-2 gap-4" 
                        }, [
                            React.createElement('div', { 
                                key: 'total',
                                className: "text-center water-card rounded-lg p-3" 
                            }, [
                                React.createElement('p', { 
                                    key: 'amount1',
                                    className: "text-xl font-bold text-blue-900 drop-shadow" 
                                }, `${totalExpenses.toLocaleString()}ì›`),
                                React.createElement('p', { 
                                    key: 'label1',
                                    className: "text-xs text-blue-700" 
                                }, "ì´ ê²½ë¹„")
                            ]),
                            React.createElement('div', { 
                                key: 'pending',
                                className: "text-center water-card rounded-lg p-3" 
                            }, [
                                React.createElement('p', { 
                                    key: 'amount2',
                                    className: "text-xl font-bold text-blue-900 drop-shadow" 
                                }, `${pendingExpenses.toLocaleString()}ì›`),
                                React.createElement('p', { 
                                    key: 'label2',
                                    className: "text-xs text-blue-700" 
                                }, "ë¯¸ì •ì‚° ê²½ë¹„")
                            ])
                        ])
                    ])
                ),

                // ğŸ–ï¸ ì´ìŠ¤í„°ì—ê·¸ í‘œì‹œ
                showEasterEgg && React.createElement('div', {
                    key: 'easter-egg',
                    className: "fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full shadow-lg animate-bounce"
                }, [
                    React.createElement('div', {
                        key: 'message',
                        className: "text-center font-bold"
                    }, easterEggMessage)
                ]),

                // ìƒˆ ê²½ë¹„ ì¶”ê°€ ë²„íŠ¼
                React.createElement('div', { 
                    key: 'add-button',
                    className: "p-4" 
                },
                    React.createElement('button', {
                        onClick: () => setShowAddForm(true),
                        className: "w-full water-button text-white rounded-lg py-3 px-4 font-medium flex items-center justify-center gap-2 shadow-lg"
                    }, [
                        React.createElement(Plus, { key: 'icon' }),
                        React.createElement('span', { key: 'text' }, "ìƒˆ ê²½ë¹„ ì¶”ê°€")
                    ])
                ),

                // ê°œì¸ë³„ ì •ì‚° í˜„í™©
                React.createElement('div', { 
                    key: 'personal',
                    className: "mx-4 mb-4" 
                }, [
                    React.createElement('div', { 
                        key: 'header',
                        className: "water-card rounded-lg p-4 shadow-sm" 
                    }, [
                        React.createElement('h2', { 
                            key: 'title',
                            className: "text-lg font-semibold mb-3 text-blue-900 flex items-center gap-2" 
                        }, [
                            React.createElement(Users, { key: 'icon' }),
                            React.createElement('span', { key: 'text' }, "íŒ€ì›ë³„ ì •ì‚° í˜„í™©")
                        ]),
                        React.createElement('div', { 
                            key: 'grid',
                            className: "grid grid-cols-2 gap-2 text-sm" 
                        },
                            members.map(member => {
                                const totals = personalTotals[member] || { paid: 0, owes: 0, net: 0 };
                                const isPositive = totals.net > 0;
                                const isZero = totals.net === 0;
                                
                                return React.createElement('div', { 
                                    key: member,
                                    className: "p-3 rounded border water-card" 
                                }, [
                                    React.createElement('div', { 
                                        key: 'name',
                                        className: "font-medium text-blue-900 flex items-center gap-1" 
                                    }, [
                                        React.createElement('span', { key: 'icon' }, member === 'ìŠ¹ìš°' ? 'ğŸ–ï¸' : 'ğŸŠâ€â™€ï¸'),
                                        React.createElement('span', { key: 'text' }, member)
                                    ]),
                                    React.createElement('div', { 
                                        key: 'amount',
                                        className: `text-xs mt-1 ${
                                            isZero ? 'text-gray-600' : 
                                            isPositive ? 'text-green-600' : 'text-red-600'
                                        }` 
                                    }, `${Math.abs(totals.net).toLocaleString()}ì›${isZero ? '' : isPositive ? ' ë°›ì„ ëˆ' : ' ì¤„ ëˆ'}`)
                                ]);
                            })
                        )
                    ])
                ]),

                // ê²½ë¹„ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸
                React.createElement('div', { 
                    key: 'expenses-list',
                    className: "mx-4 space-y-3" 
                },
                    expenses.length === 0 
                        ? React.createElement('div', { 
                            key: 'empty',
                            className: "text-center py-8 text-gray-500" 
                        }, [
                            React.createElement('p', { key: 'text' }, "ğŸŠâ€â™€ï¸ ì•„ì§ ê²½ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤"),
                            React.createElement('p', { key: 'sub', className: "text-sm" }, "ì²« ê²½ë¹„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!")
                        ])
                        : expenses.map(expense => {
                            const category = categories.find(c => c.id === expense.category) || categories[4];
                            const isCompleted = isExpenseCompleted(expense);
                            
                            return React.createElement('div', { 
                                key: expense.id,
                                className: `water-card rounded-lg shadow-sm ${isCompleted ? 'opacity-60' : ''}` 
                            }, [
                                React.createElement('div', { 
                                    key: 'main',
                                    className: "p-4" 
                                }, [
                                    React.createElement('div', { 
                                        key: 'header',
                                        className: "flex items-center justify-between mb-2" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'left',
                                            className: "flex items-center gap-3" 
                                        }, [
                                            React.createElement('span', { 
                                                key: 'icon',
                                                className: "text-xl" 
                                            }, category.icon),
                                            React.createElement('div', { key: 'info' }, [
                                                React.createElement('h3', { 
                                                    key: 'title',
                                                    className: `font-medium text-blue-900 ${isCompleted ? 'line-through' : ''}` 
                                                }, expense.title),
                                                React.createElement('p', { 
                                                    key: 'meta',
                                                    className: "text-xs text-blue-700" 
                                                }, `${expense.payer} ê²°ì œ â€¢ ${expense.date} ${expense.time}`)
                                            ])
                                        ]),
                                        React.createElement('div', { 
                                            key: 'right',
                                            className: "text-right" 
                                        }, [
                                            React.createElement('p', { 
                                                key: 'amount',
                                                className: `text-lg font-bold text-blue-900 ${isCompleted ? 'line-through' : ''}` 
                                            }, `${expense.amount.toLocaleString()}ì›`),
                                            React.createElement('button', {
                                                key: 'menu',
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    setShowExpenseMenu(prev => ({
                                                        ...prev,
                                                        [expense.id]: !prev[expense.id]
                                                    }));
                                                },
                                                className: "p-1 text-blue-600 hover:bg-blue-100 rounded"
                                            }, React.createElement(MoreVertical, { size: 16 }))
                                        ])
                                    ]),
                                    
                                    // ë©”ë‰´
                                    showExpenseMenu[expense.id] && React.createElement('div', { 
                                        key: 'menu',
                                        className: "absolute right-4 mt-2 bg-white rounded-lg shadow-lg border py-1 z-20" 
                                    }, [
                                        React.createElement('button', {
                                            key: 'edit',
                                            onClick: () => startEdit(expense),
                                            className: "w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center gap-2 text-sm"
                                        }, [
                                            React.createElement(Edit3, { key: 'icon', size: 14 }),
                                            React.createElement('span', { key: 'text' }, "ìˆ˜ì •")
                                        ]),
                                        React.createElement('button', {
                                            key: 'complete',
                                            onClick: () => toggleExpenseCompletion(expense.id),
                                            className: "w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center gap-2 text-sm"
                                        }, [
                                            React.createElement(Check, { key: 'icon', size: 14 }),
                                            React.createElement('span', { key: 'text' }, isCompleted ? "ì •ì‚° í•´ì œ" : "ì „ì²´ ì™„ë£Œ")
                                        ]),
                                        React.createElement('button', {
                                            key: 'delete',
                                            onClick: () => deleteExpense(expense.id, expense.title),
                                            className: "w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center gap-2 text-sm text-red-600"
                                        }, [
                                            React.createElement(Trash2, { key: 'icon', size: 14 }),
                                            React.createElement('span', { key: 'text' }, "ì‚­ì œ")
                                        ])
                                    ]),

                                    // ì •ì‚° ì •ë³´
                                    React.createElement('div', { 
                                        key: 'settlement',
                                        className: "flex items-center justify-between text-sm mt-3 pt-3 border-t border-blue-100" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'participants',
                                            className: "flex items-center gap-2" 
                                        }, [
                                            React.createElement('span', { 
                                                key: 'label',
                                                className: "text-blue-700" 
                                            }, "ì°¸ì—¬ì:"),
                                            React.createElement('span', { 
                                                key: 'count',
                                                className: "text-blue-900 font-medium" 
                                            }, `${expense.participants?.length || 0}ëª…`)
                                        ]),
                                        React.createElement('div', { 
                                            key: 'status',
                                            className: "flex items-center gap-2" 
                                        }, [
                                            React.createElement('button', {
                                                key: 'toggle',
                                                onClick: () => setExpandedExpenses(prev => ({
                                                    ...prev,
                                                    [expense.id]: !prev[expense.id]
                                                })),
                                                className: "text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                            }, [
                                                React.createElement('span', { key: 'text' }, "ê°œë³„ ì •ì‚°"),
                                                React.createElement(expandedExpenses[expense.id] ? ChevronUp : ChevronDown, { 
                                                    key: 'icon',
                                                    size: 16 
                                                })
                                            ]),
                                            (() => {
                                                try {
                                                    if (!expense || !Array.isArray(expense.participants)) {
                                                        return React.createElement('span', { 
                                                            key: 'completed',
                                                            className: "text-xs text-gray-500" 
                                                        }, "0/0ëª…");
                                                    }
                                                    const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                                                    const completedCount = expense.participants.filter(p => {
                                                        return p && typeof p === 'string' && completedBy[p] === true;
                                                    }).length;
                                                    return React.createElement('span', { 
                                                        key: 'completed',
                                                        className: "text-xs text-blue-700" 
                                                    }, `${completedCount}/${expense.participants.length}ëª…`);
                                                } catch (error) {
                                                    console.error('completedCount ê³„ì‚° ì—ëŸ¬:', error);
                                                    return React.createElement('span', { 
                                                        key: 'completed',
                                                        className: "text-xs text-gray-500" 
                                                    }, "0/0ëª…");
                                                }
                                            })()
                                        ])
                                    ]),

                                    // ê°œë³„ ì •ì‚° ì„¸ë¶€ì‚¬í•­
                                    expandedExpenses[expense.id] && expense.participants && Array.isArray(expense.participants) && React.createElement('div', { 
                                        key: 'details',
                                        className: "grid grid-cols-2 gap-1 text-xs mt-2 pt-2 border-t border-blue-100" 
                                    },
                                        expense.participants.map(participant => {
                                            try {
                                                if (!participant || typeof participant !== 'string') {
                                                    return null;
                                                }
                                                
                                                const amount = getParticipantAmount(expense, participant);
                                                const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                                                const isCompleted = completedBy[participant] === true;
                                                
                                                return React.createElement('div', { 
                                                    key: participant,
                                                    className: `flex items-center justify-between p-2 rounded border ${
                                                        isCompleted ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'
                                                    }` 
                                                }, [
                                                    React.createElement('span', { 
                                                        key: 'name',
                                                        className: isCompleted ? 'text-green-700 line-through' : 'text-blue-700' 
                                                    }, [
                                                        participant === 'ìŠ¹ìš°' ? 'ğŸ–ï¸ ' : 'ğŸŠâ€â™€ï¸ ',
                                                        participant
                                                    ]),
                                                    React.createElement('div', { 
                                                        key: 'amount',
                                                        className: "flex items-center gap-1" 
                                                    }, [
                                                        React.createElement('span', { 
                                                            key: 'value',
                                                            className: isCompleted ? 'text-green-700 line-through' : 'text-blue-700' 
                                                        }, `${amount.toLocaleString()}ì›`),
                                                        React.createElement('button', {
                                                            key: 'check',
                                                            onClick: () => togglePersonalCompletion(expense.id, participant),
                                                            className: `p-1 rounded mobile-button ${
                                                                isCompleted 
                                                                    ? 'text-green-600 hover:text-green-700' 
                                                                    : 'text-blue-400 hover:text-blue-600'
                                                            }`
                                                        }, React.createElement(Check))
                                                    ])
                                                ]);
                                            } catch (error) {
                                                console.error('participant ë Œë”ë§ ì—ëŸ¬:', error, { participant, expense });
                                                return null;
                                            }
                                        }).filter(Boolean)
                                    )
                                ])
                            ]);
                        })
                ),

                // ìƒˆ ê²½ë¹„ ì¶”ê°€ í¼
                showAddForm && React.createElement('div', { 
                    key: 'form-overlay',
                    className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" 
                },
                    React.createElement('div', { 
                        className: "water-card rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto" 
                    }, [
                        React.createElement('h2', { 
                            key: 'form-title',
                            className: "text-lg font-semibold mb-4 text-blue-900" 
                        }, editingExpense ? "ê²½ë¹„ ìˆ˜ì •" : "ìƒˆ ê²½ë¹„ ì¶”ê°€"),
                        
                        React.createElement('form', { 
                            key: 'form',
                            onSubmit: handleSubmit,
                            className: "space-y-4" 
                        }, [
                            // ì œëª©
                            React.createElement('div', { key: 'title-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "ì œëª©"),
                                React.createElement('input', {
                                    key: 'input',
                                    type: 'text',
                                    value: formData.title,
                                    onChange: (e) => setFormData(prev => ({ ...prev, title: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                                    placeholder: "ì˜ˆ: íœì…˜ ë°”ë² í ê³ ê¸°ê°’"
                                })
                            ]),

                            // ê¸ˆì•¡
                            React.createElement('div', { key: 'amount-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "ê¸ˆì•¡"),
                                React.createElement('input', {
                                    key: 'input',
                                    type: 'number',
                                    value: formData.amount,
                                    onChange: (e) => setFormData(prev => ({ ...prev, amount: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                                    placeholder: "0"
                                })
                            ]),

                            // ê²°ì œì
                            React.createElement('div', { key: 'payer-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "ê²°ì œì"),
                                React.createElement('select', {
                                    key: 'select',
                                    value: formData.payer,
                                    onChange: (e) => setFormData(prev => ({ ...prev, payer: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                }, members.map(member => 
                                    React.createElement('option', { 
                                        key: member,
                                        value: member 
                                    }, member === 'ìŠ¹ìš°' ? `ğŸ–ï¸ ${member}` : `ğŸŠâ€â™€ï¸ ${member}`)
                                ))
                            ]),

                            // ì¹´í…Œê³ ë¦¬
                            React.createElement('div', { key: 'category-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "ì¹´í…Œê³ ë¦¬"),
                                React.createElement('select', {
                                    key: 'select',
                                    value: formData.category,
                                    onChange: (e) => setFormData(prev => ({ ...prev, category: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                }, categories.map(category => 
                                    React.createElement('option', { 
                                        key: category.id,
                                        value: category.id 
                                    }, `${category.icon} ${category.name}`)
                                ))
                            ]),

                            // ì°¸ì—¬ì
                            React.createElement('div', { key: 'participants-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "ì°¸ì—¬ì"),
                                React.createElement('div', { 
                                    key: 'checkboxes',
                                    className: "grid grid-cols-2 gap-2" 
                                }, members.map(member => 
                                    React.createElement('label', { 
                                        key: member,
                                        className: "flex items-center gap-2 cursor-pointer" 
                                    }, [
                                        React.createElement('input', {
                                            key: 'checkbox',
                                            type: 'checkbox',
                                            checked: formData.participants.includes(member),
                                            onChange: (e) => {
                                                if (e.target.checked) {
                                                    setFormData(prev => ({
                                                        ...prev,
                                                        participants: [...prev.participants, member]
                                                    }));
                                                } else {
                                                    setFormData(prev => ({
                                                        ...prev,
                                                        participants: prev.participants.filter(p => p !== member)
                                                    }));
                                                }
                                            },
                                            className: "rounded border-blue-300 text-blue-600 focus:ring-blue-500"
                                        }),
                                        React.createElement('span', { 
                                            key: 'name',
                                            className: "text-sm text-blue-900" 
                                        }, member === 'ìŠ¹ìš°' ? `ğŸ–ï¸ ${member}` : `ğŸŠâ€â™€ï¸ ${member}`)
                                    ])
                                ))
                            ]),

                            // ë²„íŠ¼ë“¤
                            React.createElement('div', { 
                                key: 'buttons',
                                className: "flex gap-3 pt-4" 
                            }, [
                                React.createElement('button', {
                                    key: 'cancel',
                                    type: 'button',
                                    onClick: () => {
                                        setShowAddForm(false);
                                        setEditingExpense(null);
                                    },
                                    className: "flex-1 px-4 py-2 border border-blue-300 rounded-lg text-blue-700 hover:bg-blue-50"
                                }, "ì·¨ì†Œ"),
                                React.createElement('button', {
                                    key: 'submit',
                                    type: 'submit',
                                    className: "flex-1 px-4 py-2 water-button text-white rounded-lg"
                                }, editingExpense ? "ìˆ˜ì •" : "ì¶”ê°€")
                            ])
                        ])
                    ])
                )
            ]);
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>
