<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진짜배기 여행 경비</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        
        /* 워터파크 테마 CSS */
        .water-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .water-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .water-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .water-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* 물방울 애니메이션 */
        @keyframes bubble {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-20px) scale(1.1); opacity: 0; }
        }
        
        .bubble {
            animation: bubble 2s infinite;
        }
        
        /* 이스터에그 스타일 */
        .easter-egg {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .easter-egg:hover {
            transform: scale(1.05);
        }
        
        /* 모바일 터치 최적화 */
        .mobile-button {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        /* 메뉴 스타일 개선 */
        .menu-dropdown {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.3), 
                0 10px 10px -5px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        
        .menu-item:hover {
            transform: translateX(2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 🎨 아이콘 컴포넌트들 (lucide 대신 단순 텍스트/이모지)
        const Plus = () => React.createElement('span', null, '+');
        const Check = () => React.createElement('span', null, '✓');
        const MoreVertical = () => React.createElement('span', null, '⋮');
        const Edit3 = () => React.createElement('span', null, '✏️');
        const Trash2 = () => React.createElement('span', null, '🗑️');
        const Users = () => React.createElement('span', null, '👥');
        const AlertCircle = () => React.createElement('span', null, '⚠️');
        const Wifi = () => React.createElement('span', null, '📶');
        const ChevronDown = () => React.createElement('span', null, '▼');
        const ChevronUp = () => React.createElement('span', null, '▲');
        const Waves = () => React.createElement('span', null, '🌊');
        const Droplets = () => React.createElement('span', null, '💧');

        // 🔥 Firebase 설정 (지역 URL 수정)
        const firebaseConfig = {
            apiKey: "AIzaSyBn2VFGn7dQHaXCrWOeVhtQFRSd9wjPMao",
            authDomain: "wandoo-trip-expenses.firebaseapp.com",
            databaseURL: "https://wandoo-trip-expenses-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wandoo-trip-expenses",
            storageBucket: "wandoo-trip-expenses.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Firebase 초기화 안전성 검사
        let database;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            console.log('✅ Firebase 연결 성공');
        } catch (error) {
            console.error('❌ Firebase 연결 실패:', error);
            // Firebase 연결 실패 시 로컬 모드로 동작
            database = null;
        }

        // 🏊‍♀️ 새로운 여행 멤버 (6명) + 활동 로그 상태
        const members = ['태웅', '재원', '재헌', '승우', '태호', '진형'];
        
        const categories = [
            { id: 'transport', name: '교통비', icon: '🚗', color: 'bg-blue-100 text-blue-800' },
            { id: 'accommodation', name: '숙박비', icon: '🏠', color: 'bg-green-100 text-green-800' },
            { id: 'food', name: '식비', icon: '🍖', color: 'bg-orange-100 text-orange-800' },
            { id: 'activity', name: '활동비', icon: '🏊‍♀️', color: 'bg-purple-100 text-purple-800' },
            { id: 'other', name: '기타', icon: '💦', color: 'bg-gray-100 text-gray-800' }
        ];

        // 💜 활동 로그 시스템 추가
        const [activityLogs, setActivityLogs] = useState([]);
        const [showGirlfriendView, setShowGirlfriendView] = useState(false);
        const [showActivityForm, setShowActivityForm] = useState(false);
        const [newActivity, setNewActivity] = useState('');

        function App() {
            // 상태 관리
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [connected, setConnected] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [expandedExpenses, setExpandedExpenses] = useState({});
            const [showExpenseMenu, setShowExpenseMenu] = useState({});
            
            // 🎖️ 이스터에그 상태
            const [clickCount, setClickCount] = useState(0);
            const [showEasterEgg, setShowEasterEgg] = useState(false);
            const [easterEggMessage, setEasterEggMessage] = useState('');

            // 💜 활동 로그 시스템 상태
            const [activityLogs, setActivityLogs] = useState([]);
            const [showGirlfriendView, setShowGirlfriendView] = useState(false);
            const [showActivityForm, setShowActivityForm] = useState(false);
            const [newActivity, setNewActivity] = useState('');
            const [pokeNotifications, setPokeNotifications] = useState([]);

            // 폼 상태
            const [formData, setFormData] = useState({
                title: '',
                amount: '',
                payer: members[0],
                participants: [...members],
                category: 'food',
                splitType: 'equal',
                customSplit: {},
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            });

            // 🔥 Firebase 연결 및 실시간 데이터 동기화 (안전 버전)
            useEffect(() => {
                console.log('🔥 Firebase 연결 시작...');
                
                // Firebase가 없으면 로컬 모드로 동작
                if (!database) {
                    console.log('⚠️ Firebase 연결 불가, 로컬 모드로 동작');
                    setConnected(false);
                    setLoading(false);
                    return;
                }

                try {
                    const expensesRef = database.ref('expenses');
                    const activityRef = database.ref('activities');
                    const pokeRef = database.ref('pokes');
                    
                    // 연결 상태 확인
                    const connectedRef = database.ref('.info/connected');
                    connectedRef.on('value', (snapshot) => {
                        const isConnected = snapshot.val() === true;
                        console.log('🌊 연결 상태:', isConnected);
                        setConnected(isConnected);
                    });

                    // 경비 데이터 동기화
                    expensesRef.on('value', (snapshot) => {
                        console.log('📊 경비 데이터 수신:', snapshot.val());
                        const data = snapshot.val();
                        if (data) {
                            const expensesList = Object.keys(data).map(key => {
                                const expense = data[key];
                                return {
                                    ...expense,
                                    id: key,
                                    participants: expense.participants || [],
                                    completedBy: expense.completedBy || {},
                                    customSplit: expense.customSplit || {},
                                    amount: expense.amount || 0,
                                    payer: expense.payer || '',
                                    title: expense.title || '',
                                    category: expense.category || 'other',
                                    date: expense.date || new Date().toISOString().split('T')[0],
                                    time: expense.time || '00:00'
                                };
                            });
                            setExpenses(expensesList);
                            console.log('✅ 경비 데이터 로드 완료:', expensesList.length, '개');
                        } else {
                            setExpenses([]);
                            console.log('📝 경비 데이터 없음');
                        }
                        setLoading(false);
                    });

                    // 💜 활동 로그 동기화
                    activityRef.on('value', (snapshot) => {
                        console.log('📝 활동 로그 수신:', snapshot.val());
                        const data = snapshot.val();
                        if (data) {
                            const logsList = Object.keys(data).map(key => ({
                                ...data[key],
                                id: key
                            })).sort((a, b) => b.timestamp - a.timestamp); // 최신순
                            setActivityLogs(logsList);
                            console.log('✅ 활동 로그 로드 완료:', logsList.length, '개');
                        } else {
                            setActivityLogs([]);
                        }
                    });

                    // 💜 찌르기 알림 동기화
                    pokeRef.on('value', (snapshot) => {
                        console.log('💜 찌르기 알림 수신:', snapshot.val());
                        const data = snapshot.val();
                        if (data) {
                            const pokeList = Object.keys(data).map(key => ({
                                ...data[key],
                                id: key
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            setPokeNotifications(pokeList);
                            
                            // 새로운 찌르기가 있으면 알림 표시
                            const latestPoke = pokeList[0];
                            if (latestPoke && (Date.now() - latestPoke.timestamp < 10000)) {
                                alert(`💜 ${latestPoke.message}`);
                                setShowActivityForm(true);
                            }
                        } else {
                            setPokeNotifications([]);
                        }
                    });

                    // 타임아웃 설정 (10초 후 강제 로딩 완료)
                    const timeout = setTimeout(() => {
                        console.log('⏰ 로딩 타임아웃, 강제 완료');
                        setLoading(false);
                    }, 10000);

                    // 컴포넌트 언마운트 시 리스너 해제
                    return () => {
                        console.log('🔄 Firebase 리스너 해제');
                        clearTimeout(timeout);
                        expensesRef.off();
                        activityRef.off();
                        pokeRef.off();
                        connectedRef.off();
                    };
                } catch (error) {
                    console.error('❌ Firebase 연결 중 에러:', error);
                    setConnected(false);
                    setLoading(false);
                }
            }, []);

            // 외부 클릭 시 메뉴 닫기
            useEffect(() => {
                const handleClickOutside = () => {
                    setShowExpenseMenu({});
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            // 🎖️ 이스터에그 로직
            const handleTitleClick = () => {
                const newCount = clickCount + 1;
                setClickCount(newCount);
                
                if (newCount === 3) {
                    setShowEasterEgg(true);
                    setEasterEggMessage('🎖️ 승우 입대대기방 🎖️');
                } else if (newCount === 5) {
                    setEasterEggMessage('📅 D-day: 9월 입대 예정! 💪');
                } else if (newCount === 7) {
                    setEasterEggMessage('🫡 마지막 자유여행을 즐겨라! 🏊‍♀️');
                    setTimeout(() => {
                        setShowEasterEgg(false);
                        setClickCount(0);
                    }, 3000);
                }
            };

            // Firebase 업데이트 함수들 (안전 버전)
            const updateExpenseInFirebase = (expenseId, updates) => {
                if (!database) {
                    console.log('⚠️ Firebase 연결 없음, 업데이트 불가');
                    alert('오프라인 상태입니다.');
                    return;
                }
                try {
                    console.log('🔄 Firebase 업데이트:', { expenseId, updates });
                    database.ref(`expenses/${expenseId}`).update(updates);
                } catch (error) {
                    console.error('Firebase 업데이트 에러:', error);
                    alert('업데이트 중 오류가 발생했습니다.');
                }
            };

            const deleteExpenseFromFirebase = (expenseId) => {
                if (!database) {
                    console.log('⚠️ Firebase 연결 없음, 삭제 불가');
                    alert('오프라인 상태입니다.');
                    return;
                }
                try {
                    console.log('🗑️ Firebase 삭제:', expenseId);
                    database.ref(`expenses/${expenseId}`).remove();
                } catch (error) {
                    console.error('Firebase 삭제 에러:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                }
            };

            const addExpenseToFirebase = (expenseData) => {
                if (!database) {
                    console.log('⚠️ Firebase 연결 없음, 추가 불가');
                    alert('오프라인 상태입니다.');
                    return null;
                }
                try {
                    console.log('➕ Firebase 추가:', expenseData);
                    const newExpenseRef = database.ref('expenses').push();
                    newExpenseRef.set({
                        ...expenseData,
                        createdAt: Date.now(),
                        completedBy: {}
                    });
                    return newExpenseRef.key;
                } catch (error) {
                    console.error('Firebase 추가 에러:', error);
                    alert('추가 중 오류가 발생했습니다.');
                    return null;
                }
            };

            // 🗑️ 전체 데이터 초기화 함수
            const clearAllData = () => {
                const userConfirm = window.confirm(`⚠️ 정말 모든 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 활동 로그도 모두 사라집니다.`);
                
                if (userConfirm) {
                    const doubleConfirm = window.confirm(`🔥 마지막 확인!\n\n정말로 모든 데이터를 삭제하고 새로 시작하시겠습니까?`);
                    
                    if (doubleConfirm) {
                        if (!database) {
                            alert('⚠️ 오프라인 상태입니다.');
                            return;
                        }
                        try {
                            console.log('🗑️ 전체 데이터 삭제 시작...');
                            database.ref('expenses').remove();
                            database.ref('activities').remove();
                            database.ref('pokes').remove();
                            alert('✅ 모든 데이터가 삭제되었습니다!\n새로운 여행을 시작하세요! 🏊‍♀️');
                        } catch (error) {
                            console.error('데이터 삭제 에러:', error);
                            alert('❌ 삭제 중 오류가 발생했습니다: ' + error.message);
                        }
                    }
                }
            };

            // 폼 핸들러들 (활동 로그 추가 포함)
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.title.trim() || !formData.amount) {
                    alert('제목과 금액을 입력해주세요.');
                    return;
                }

                const expenseData = {
                    ...formData,
                    amount: parseInt(formData.amount),
                    participants: [...formData.participants]
                };

                if (editingExpense) {
                    updateExpenseInFirebase(editingExpense.id, expenseData);
                } else {
                    addExpenseWithActivity(expenseData);
                }

                setShowAddForm(false);
                setEditingExpense(null);
                setFormData({
                    title: '',
                    amount: '',
                    payer: members[0],
                    participants: [...members],
                    category: 'food',
                    splitType: 'equal',
                    customSplit: {},
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().slice(0, 5)
                });
            };

            // 정산 관련 함수들
            const togglePersonalCompletion = (expenseId, member) => {
                try {
                    console.log('개인 정산 시작:', { expenseId, member });
                    
                    const expense = expenses.find(e => e && e.id === expenseId);
                    if (!expense) {
                        console.error('경비를 찾을 수 없음:', expenseId);
                        alert('경비 정보를 찾을 수 없습니다.');
                        return;
                    }
                    
                    if (!member || typeof member !== 'string') {
                        console.error('잘못된 멤버 이름:', member);
                        alert('멤버 정보가 올바르지 않습니다.');
                        return;
                    }
                    
                    const memberAmount = getParticipantAmount(expense, member);
                    console.log('멤버 금액:', memberAmount);
                    
                    const userConfirm = window.confirm(`${member}님의 ${memberAmount.toLocaleString()}원 정산을 완료하시겠습니까?`);
                    
                    if (userConfirm) {
                        const currentCompletedBy = expense.completedBy && typeof expense.completedBy === 'object' ? {...expense.completedBy} : {};
                        const currentStatus = currentCompletedBy[member] === true;
                        
                        currentCompletedBy[member] = !currentStatus;
                        
                        console.log('정산 상태 업데이트:', { 
                            expenseId, 
                            member, 
                            currentStatus, 
                            newStatus: !currentStatus,
                            newCompletedBy: currentCompletedBy
                        });
                        
                        updateExpenseInFirebase(expenseId, { completedBy: currentCompletedBy });
                    }
                    
                } catch (error) {
                    console.error('개인 정산 처리 에러:', error);
                    alert('정산 처리 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                }
            };

            const toggleExpenseCompletion = (expenseId) => {
                const expense = expenses.find(e => e && e.id === expenseId);
                if (!expense) {
                    alert('경비 정보를 찾을 수 없습니다.');
                    return;
                }
                
                const isCompleted = isExpenseCompleted(expense);
                
                const message = isCompleted 
                    ? `"${expense.title}" 항목의 전체 정산을 해제하시겠습니까?`
                    : `"${expense.title}" 항목의 전체 정산을 완료하시겠습니까?`;
                
                const userConfirm = window.confirm(message);
                
                if (userConfirm) {
                    try {
                        let newCompletedBy = {};
                        if (!isCompleted && expense.participants) {
                            expense.participants.forEach(participant => {
                                newCompletedBy[participant] = true;
                            });
                        }
                        
                        console.log('전체 정산 상태 업데이트:', { 
                            expenseId, 
                            isCompleted, 
                            newCompletedBy 
                        });
                        
                        updateExpenseInFirebase(expenseId, { completedBy: newCompletedBy });
                        
                    } catch (error) {
                        console.error('전체 정산 처리 에러:', error);
                        alert('정산 처리 중 오류가 발생했습니다: ' + error.message);
                    }
                }
            };

            const deleteExpense = (expenseId, title) => {
                const userConfirm = window.confirm(`"${title}" 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`);
                
                if (userConfirm) {
                    try {
                        console.log('경비 삭제:', { expenseId, title });
                        deleteExpenseFromFirebase(expenseId);
                        setShowExpenseMenu({});
                    } catch (error) {
                        console.error('삭제 처리 에러:', error);
                        alert('삭제 처리 중 오류가 발생했습니다: ' + error.message);
                    }
                }
            };

            const isExpenseCompleted = (expense) => {
                try {
                    if (!expense || typeof expense !== 'object') {
                        return false;
                    }
                    
                    const participants = expense.participants;
                    if (!Array.isArray(participants) || participants.length === 0) {
                        return false;
                    }
                    
                    const completedBy = expense.completedBy;
                    if (!completedBy || typeof completedBy !== 'object') {
                        return false;
                    }
                    
                    return participants.every(participant => {
                        if (!participant || typeof participant !== 'string') {
                            return false;
                        }
                        return completedBy[participant] === true;
                    });
                } catch (error) {
                    console.error('isExpenseCompleted 에러:', error);
                    return false;
                }
            };

            const getParticipantAmount = (expense, member) => {
                try {
                    if (!expense || typeof expense !== 'object' || !member || typeof member !== 'string') {
                        return 0;
                    }
                    
                    const participants = expense.participants;
                    if (!Array.isArray(participants) || !participants.includes(member)) {
                        return 0;
                    }
                    
                    const customSplit = expense.customSplit && typeof expense.customSplit === 'object' ? expense.customSplit : {};
                    
                    if (expense.splitType === 'custom' && customSplit[member] && typeof customSplit[member] === 'number') {
                        return customSplit[member];
                    }
                    
                    const totalAmount = typeof expense.amount === 'number' ? expense.amount : 0;
                    const customTotal = Object.values(customSplit).reduce((sum, val) => {
                        return sum + (typeof val === 'number' ? val : 0);
                    }, 0);
                    
                    const remainingAmount = totalAmount - customTotal;
                    const remainingParticipants = participants.filter(p => 
                        p && typeof p === 'string' && !customSplit[p]
                    );
                    
                    return remainingParticipants.length > 0 ? Math.round(remainingAmount / remainingParticipants.length) : 0;
                } catch (error) {
                    console.error('getParticipantAmount 에러:', error, { expense, member });
                    return 0;
                }
            };

            const calculatePersonalExpenses = () => {
                try {
                    const personalTotals = {};
                    
                    if (!Array.isArray(members)) {
                        console.error('members가 배열이 아님');
                        return {};
                    }
                    
                    members.forEach(member => {
                        if (member && typeof member === 'string') {
                            personalTotals[member] = { paid: 0, owes: 0, net: 0 };
                        }
                    });

                    const activeExpenses = expenses.filter(expense => {
                        try {
                            return expense && typeof expense === 'object' && !isExpenseCompleted(expense);
                        } catch (error) {
                            console.error('activeExpenses 필터 에러:', error);
                            return false;
                        }
                    });

                    activeExpenses.forEach(expense => {
                        try {
                            if (!expense || typeof expense !== 'object') {
                                return;
                            }
                            
                            const payer = expense.payer;
                            if (payer && typeof payer === 'string' && personalTotals[payer]) {
                                const amount = typeof expense.amount === 'number' ? expense.amount : 0;
                                personalTotals[payer].paid += amount;
                            }
                            
                            const participants = expense.participants;
                            const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                            
                            if (Array.isArray(participants)) {
                                participants.forEach(participant => {
                                    try {
                                        if (participant && 
                                            typeof participant === 'string' && 
                                            personalTotals[participant] && 
                                            completedBy[participant] !== true) {
                                            
                                            const amount = getParticipantAmount(expense, participant);
                                            if (typeof amount === 'number' && amount >= 0) {
                                                personalTotals[participant].owes += amount;
                                            }
                                        }
                                    } catch (error) {
                                        console.error('participant 처리 에러:', error, { participant, expense });
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('expense 처리 에러:', error, expense);
                        }
                    });

                    Object.keys(personalTotals).forEach(member => {
                        try {
                            if (personalTotals[member] && typeof personalTotals[member] === 'object') {
                                const paid = personalTotals[member].paid || 0;
                                const owes = personalTotals[member].owes || 0;
                                personalTotals[member].net = paid - owes;
                            }
                        } catch (error) {
                            console.error('net 계산 에러:', error, { member });
                        }
                    });

                    return personalTotals;
                } catch (error) {
                    console.error('calculatePersonalExpenses 전체 에러:', error);
                    const safeTotals = {};
                    members.forEach(member => {
                        if (member && typeof member === 'string') {
                            safeTotals[member] = { paid: 0, owes: 0, net: 0 };
                        }
                    });
                    return safeTotals;
                }
            };

            // 총 경비 계산
            const totalExpenses = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const pendingExpenses = expenses.filter(expense => !isExpenseCompleted(expense))
                .reduce((sum, expense) => sum + (expense.amount || 0), 0);

            const personalTotals = calculatePersonalExpenses();

            // 폼 핸들러들
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.title.trim() || !formData.amount) {
                    alert('제목과 금액을 입력해주세요.');
                    return;
                }

                const expenseData = {
                    ...formData,
                    amount: parseInt(formData.amount),
                    participants: [...formData.participants]
                };

                if (editingExpense) {
                    updateExpenseInFirebase(editingExpense.id, expenseData);
                } else {
                    addExpenseToFirebase(expenseData);
                }

                setShowAddForm(false);
                setEditingExpense(null);
                setFormData({
                    title: '',
                    amount: '',
                    payer: members[0],
                    participants: [...members],
                    category: 'food',
                    splitType: 'equal',
                    customSplit: {},
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().slice(0, 5)
                });
            };

            const startEdit = (expense) => {
                setEditingExpense(expense);
                setFormData({
                    title: expense.title,
                    amount: expense.amount.toString(),
                    payer: expense.payer,
                    participants: [...expense.participants],
                    category: expense.category,
                    splitType: expense.splitType || 'equal',
                    customSplit: expense.customSplit || {},
                    date: expense.date,
                    time: expense.time
                });
                setShowAddForm(true);
                setShowExpenseMenu({});
            };

            if (loading) {
                return React.createElement('div', { 
                    className: "min-h-screen water-theme flex items-center justify-center" 
                }, 
                    React.createElement('div', { className: "text-center text-white" }, [
                        React.createElement('div', { 
                            key: 'spinner',
                            className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white mb-4" 
                        }),
                        React.createElement('p', { key: 'text' }, "🏊‍♀️ 케리비안베이 데이터 로딩중..."),
                        React.createElement('p', { 
                            key: 'tip',
                            className: "text-xs text-white/70 mt-2" 
                        }, "10초 이상 걸리면 새로고침 해주세요"),
                        React.createElement('button', {
                            key: 'skip',
                            onClick: () => setLoading(false),
                            className: "mt-4 px-4 py-2 bg-white/20 rounded-lg text-white text-sm hover:bg-white/30"
                        }, "로딩 건너뛰기")
                    ])
                );
            }
                // 🏊‍♀️ 워터파크 테마 헤더
                React.createElement('div', { 
                    key: 'header',
                    className: "water-theme shadow-lg sticky top-0 z-10 relative" 
                }, 
                    React.createElement('div', { className: "px-4 py-4" }, [
                        React.createElement('div', { 
                            key: 'title',
                            className: "text-center" 
                        }, [
                            React.createElement('div', {
                                key: 'title-section',
                                className: "easter-egg",
                                onClick: handleTitleClick
                            }, [
                                React.createElement('h1', { 
                                    key: 'h1',
                                    className: "text-xl font-bold text-white drop-shadow-lg" 
                                }, "🏊‍♀️ 진짜배기 여행"),
                                React.createElement('p', { 
                                    key: 'subtitle',
                                    className: "text-sm text-white/90 font-medium" 
                                }, "7/24(목) ~ 7/25(금) • 펜션 → 바베큐 → 케리비안베이")
                            ]),
                            // 연결 상태 표시
                            React.createElement('div', { 
                                key: 'status',
                                className: `flex items-center justify-center gap-1 mt-1 text-xs ${connected ? 'text-white/90' : 'text-red-200'}` 
                            }, [
                                React.createElement('span', { key: 'icon' }, '🌊'),
                                React.createElement('span', { key: 'text' }, connected ? '실시간 연결됨' : '⚠️ 연결 끊김')
                            ]),
                            
                            // 🗑️ 데이터 초기화 버튼 (작게, 오른쪽 구석에)
                            React.createElement('div', {
                                key: 'admin-controls',
                                className: "absolute top-2 right-2 flex items-center gap-2"
                            }, [
                                // 💜 여자친구 뷰 토글 버튼
                                React.createElement('button', {
                                    key: 'girlfriend-view',
                                    onClick: () => setShowGirlfriendView(!showGirlfriendView),
                                    className: `text-xs px-3 py-1 rounded transition-all ${
                                        showGirlfriendView 
                                            ? 'bg-pink-500 text-white' 
                                            : 'bg-white/20 hover:bg-white/40 text-white'
                                    }`,
                                    title: showGirlfriendView ? "남자들 뷰로 전환" : "여자친구 뷰로 전환"
                                }, showGirlfriendView ? "💙 남자들" : "💜 여친"),
                                
                                React.createElement('button', {
                                    key: 'clear-data',
                                    onClick: clearAllData,
                                    className: "text-xs px-2 py-1 bg-red-500/20 hover:bg-red-500/40 text-white rounded opacity-50 hover:opacity-100 transition-opacity",
                                    title: "모든 데이터 삭제"
                                }, "🗑️")
                            ])
                        ]),
                        React.createElement('div', { 
                            key: 'totals',
                            className: "mt-4 grid grid-cols-2 gap-4" 
                        }, [
                            React.createElement('div', { 
                                key: 'total',
                                className: "text-center water-card rounded-lg p-3" 
                            }, [
                                React.createElement('p', { 
                                    key: 'amount1',
                                    className: "text-xl font-bold text-blue-900 drop-shadow" 
                                }, `${totalExpenses.toLocaleString()}원`),
                                React.createElement('p', { 
                                    key: 'label1',
                                    className: "text-xs text-blue-700" 
                                }, "총 경비")
                            ]),
                            React.createElement('div', { 
                                key: 'pending',
                                className: "text-center water-card rounded-lg p-3" 
                            }, [
                                React.createElement('p', { 
                                    key: 'amount2',
                                    className: "text-xl font-bold text-blue-900 drop-shadow" 
                                }, `${pendingExpenses.toLocaleString()}원`),
                                React.createElement('p', { 
                                    key: 'label2',
                                    className: "text-xs text-blue-700" 
                                }, "미정산 경비")
                            ])
                        ])
                    ])
                ),

                // 🎖️ 이스터에그 표시
                showEasterEgg && React.createElement('div', {
                    key: 'easter-egg',
                    className: "fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full shadow-lg animate-bounce"
                }, [
                    React.createElement('div', {
                        key: 'message',
                        className: "text-center font-bold"
                    }, easterEggMessage)
                ]),

                // 새 경비 추가 버튼
                React.createElement('div', { 
                    key: 'add-button',
                    className: "p-4" 
                },
                    React.createElement('button', {
                        onClick: () => setShowAddForm(true),
                        className: "w-full water-button text-white rounded-lg py-3 px-4 font-medium flex items-center justify-center gap-2 shadow-lg"
                    }, [
                        React.createElement('span', { key: 'icon' }, '+'),
                        React.createElement('span', { key: 'text' }, "새 경비 추가")
                    ])
                ),

                // 개인별 정산 현황
                React.createElement('div', { 
                    key: 'personal',
                    className: "mx-4 mb-4" 
                }, [
                    React.createElement('div', { 
                        key: 'header',
                        className: "water-card rounded-lg p-4 shadow-sm" 
                    }, [
                        React.createElement('h2', { 
                            key: 'title',
                            className: "text-lg font-semibold mb-3 text-blue-900 flex items-center gap-2" 
                        }, [
                            React.createElement('span', { key: 'icon' }, '👥'),
                            React.createElement('span', { key: 'text' }, "팀원별 정산 현황")
                        ]),
                        React.createElement('div', { 
                            key: 'grid',
                            className: "grid grid-cols-2 gap-2 text-sm" 
                        },
                            members.map(member => {
                                const totals = personalTotals[member] || { paid: 0, owes: 0, net: 0 };
                                const isPositive = totals.net > 0;
                                const isZero = totals.net === 0;
                                
                                return React.createElement('div', { 
                                    key: member,
                                    className: "p-3 rounded border water-card" 
                                }, [
                                    React.createElement('div', { 
                                        key: 'name',
                                        className: "font-medium text-blue-900 flex items-center gap-1" 
                                    }, [
                                        React.createElement('span', { key: 'icon' }, member === '승우' ? '🎖️' : '🏊‍♀️'),
                                        React.createElement('span', { key: 'text' }, member)
                                    ]),
                                    React.createElement('div', { 
                                        key: 'amount',
                                        className: `text-xs mt-1 ${
                                            isZero ? 'text-gray-600' : 
                                            isPositive ? 'text-green-600' : 'text-red-600'
                                        }` 
                                    }, `${Math.abs(totals.net).toLocaleString()}원${isZero ? '' : isPositive ? ' 받을 돈' : ' 줄 돈'}`)
                                ]);
                            })
                        )
                    ])
                ]),

                // 경비 내역 리스트
                React.createElement('div', { 
                    key: 'expenses-list',
                    className: "mx-4 space-y-3 relative" 
                },
                    expenses.length === 0 
                        ? React.createElement('div', { 
                            key: 'empty',
                            className: "text-center py-8 text-gray-500" 
                        }, [
                            React.createElement('p', { key: 'text' }, "🏊‍♀️ 아직 경비가 없습니다"),
                            React.createElement('p', { key: 'sub', className: "text-sm" }, "첫 경비를 추가해보세요!")
                        ])
                        : expenses.map(expense => {
                            const category = categories.find(c => c.id === expense.category) || categories[4];
                            const isCompleted = isExpenseCompleted(expense);
                            
                            return React.createElement('div', { 
                                key: expense.id,
                                className: `water-card rounded-lg shadow-sm relative overflow-visible ${isCompleted ? 'opacity-60' : ''}`,
                                style: { zIndex: showExpenseMenu[expense.id] ? 60 : 1 }
                            }, [
                                React.createElement('div', { 
                                    key: 'main',
                                    className: "p-4" 
                                }, [
                                    React.createElement('div', { 
                                        key: 'header',
                                        className: "flex items-center justify-between mb-2" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'left',
                                            className: "flex items-center gap-3" 
                                        }, [
                                            React.createElement('span', { 
                                                key: 'icon',
                                                className: "text-xl" 
                                            }, category.icon),
                                            React.createElement('div', { key: 'info' }, [
                                                React.createElement('h3', { 
                                                    key: 'title',
                                                    className: `font-medium text-blue-900 ${isCompleted ? 'line-through' : ''}` 
                                                }, expense.title),
                                                React.createElement('p', { 
                                                    key: 'meta',
                                                    className: "text-xs text-blue-700" 
                                                }, `${expense.payer} 결제 • ${expense.date} ${expense.time}`)
                                            ])
                                        ]),
                                        React.createElement('div', { 
                                            key: 'right',
                                            className: "text-right" 
                                        }, [
                                            React.createElement('p', { 
                                                key: 'amount',
                                                className: `text-lg font-bold text-blue-900 ${isCompleted ? 'line-through' : ''}` 
                                            }, `${expense.amount.toLocaleString()}원`),
                                            React.createElement('button', {
                                                key: 'menu',
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    setShowExpenseMenu(prev => ({
                                                        ...prev,
                                                        [expense.id]: !prev[expense.id]
                                                    }));
                                                },
                                                className: "p-1 text-blue-600 hover:bg-blue-100 rounded"
                                            }, React.createElement('span', { className: "text-xs" }, '⋮'))
                                        ])
                                    ]),
                                    
                                    // 메뉴 배경 오버레이 + 메뉴
                                    showExpenseMenu[expense.id] && React.createElement('div', {
                                        key: 'menu-overlay',
                                        className: "fixed inset-0 z-40",
                                        onClick: () => setShowExpenseMenu({})
                                    }),
                                    
                                    showExpenseMenu[expense.id] && React.createElement('div', { 
                                        key: 'menu',
                                        className: "menu-dropdown absolute right-0 top-8 rounded-lg py-1 z-50 min-w-[140px]",
                                        style: {
                                            marginTop: '4px'
                                        },
                                        onClick: (e) => e.stopPropagation()
                                    }, [
                                        React.createElement('button', {
                                            key: 'edit',
                                            onClick: () => startEdit(expense),
                                            className: "menu-item w-full px-4 py-3 text-left hover:bg-blue-50 flex items-center gap-2 text-sm border-b border-gray-100 last:border-b-0"
                                        }, [
                                            React.createElement('span', { key: 'icon' }, '✏️'),
                                            React.createElement('span', { key: 'text' }, "수정")
                                        ]),
                                        React.createElement('button', {
                                            key: 'complete',
                                            onClick: () => toggleExpenseCompletion(expense.id),
                                            className: "menu-item w-full px-4 py-3 text-left hover:bg-green-50 flex items-center gap-2 text-sm border-b border-gray-100 last:border-b-0"
                                        }, [
                                            React.createElement('span', { key: 'icon' }, '✓'),
                                            React.createElement('span', { key: 'text' }, isCompleted ? "정산 해제" : "전체 완료")
                                        ]),
                                        React.createElement('button', {
                                            key: 'delete',
                                            onClick: () => deleteExpense(expense.id, expense.title),
                                            className: "menu-item w-full px-4 py-3 text-left hover:bg-red-50 flex items-center gap-2 text-sm text-red-600"
                                        }, [
                                            React.createElement('span', { key: 'icon' }, '🗑️'),
                                            React.createElement('span', { key: 'text' }, "삭제")
                                        ])
                                    ]),

                                    // 정산 정보
                                    React.createElement('div', { 
                                        key: 'settlement',
                                        className: "flex items-center justify-between text-sm mt-3 pt-3 border-t border-blue-100" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'participants',
                                            className: "flex items-center gap-2" 
                                        }, [
                                            React.createElement('span', { 
                                                key: 'label',
                                                className: "text-blue-700" 
                                            }, "참여자:"),
                                            React.createElement('span', { 
                                                key: 'count',
                                                className: "text-blue-900 font-medium" 
                                            }, `${expense.participants?.length || 0}명`)
                                        ]),
                                        React.createElement('div', { 
                                            key: 'status',
                                            className: "flex items-center gap-2" 
                                        }, [
                                            React.createElement('button', {
                                                key: 'toggle',
                                                onClick: () => setExpandedExpenses(prev => ({
                                                    ...prev,
                                                    [expense.id]: !prev[expense.id]
                                                })),
                                                className: "text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                            }, [
                                                React.createElement('span', { key: 'text' }, "개별 정산"),
                                                React.createElement(expandedExpenses[expense.id] ? ChevronUp : ChevronDown, { 
                                                    key: 'icon',
                                                    size: 16 
                                                })
                                            ]),
                                            (() => {
                                                try {
                                                    if (!expense || !Array.isArray(expense.participants)) {
                                                        return React.createElement('span', { 
                                                            key: 'completed',
                                                            className: "text-xs text-gray-500" 
                                                        }, "0/0명");
                                                    }
                                                    const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                                                    const completedCount = expense.participants.filter(p => {
                                                        return p && typeof p === 'string' && completedBy[p] === true;
                                                    }).length;
                                                    return React.createElement('span', { 
                                                        key: 'completed',
                                                        className: "text-xs text-blue-700" 
                                                    }, `${completedCount}/${expense.participants.length}명`);
                                                } catch (error) {
                                                    console.error('completedCount 계산 에러:', error);
                                                    return React.createElement('span', { 
                                                        key: 'completed',
                                                        className: "text-xs text-gray-500" 
                                                    }, "0/0명");
                                                }
                                            })()
                                        ])
                                    ]),

                                    // 개별 정산 세부사항
                                    expandedExpenses[expense.id] && expense.participants && Array.isArray(expense.participants) && React.createElement('div', { 
                                        key: 'details',
                                        className: "grid grid-cols-2 gap-1 text-xs mt-2 pt-2 border-t border-blue-100" 
                                    },
                                        expense.participants.map(participant => {
                                            try {
                                                if (!participant || typeof participant !== 'string') {
                                                    return null;
                                                }
                                                
                                                const amount = getParticipantAmount(expense, participant);
                                                const completedBy = expense.completedBy && typeof expense.completedBy === 'object' ? expense.completedBy : {};
                                                const isCompleted = completedBy[participant] === true;
                                                
                                                return React.createElement('div', { 
                                                    key: participant,
                                                    className: `flex items-center justify-between p-2 rounded border ${
                                                        isCompleted ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'
                                                    }` 
                                                }, [
                                                    React.createElement('span', { 
                                                        key: 'name',
                                                        className: isCompleted ? 'text-green-700 line-through' : 'text-blue-700' 
                                                    }, [
                                                        participant === '승우' ? '🎖️ ' : '🏊‍♀️ ',
                                                        participant
                                                    ]),
                                                    React.createElement('div', { 
                                                        key: 'amount',
                                                        className: "flex items-center gap-1" 
                                                    }, [
                                                        React.createElement('span', { 
                                                            key: 'value',
                                                            className: isCompleted ? 'text-green-700 line-through' : 'text-blue-700' 
                                                        }, `${amount.toLocaleString()}원`),
                                                        React.createElement('button', {
                                                            key: 'check',
                                                            onClick: () => togglePersonalCompletion(expense.id, participant),
                                                            className: `p-1 rounded mobile-button ${
                                                                isCompleted 
                                                                    ? 'text-green-600 hover:text-green-700' 
                                                                    : 'text-blue-400 hover:text-blue-600'
                                                            }`
                                                        }, React.createElement(Check))
                                                    ])
                                                ]);
                                            } catch (error) {
                                                console.error('participant 렌더링 에러:', error, { participant, expense });
                                                return null;
                                            }
                                        }).filter(Boolean)
                                    )
                                ])
                            ]);
                        })
                ),

                // 새 경비 추가 폼
                showAddForm && React.createElement('div', { 
                    key: 'form-overlay',
                    className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" 
                },
                    React.createElement('div', { 
                        className: "water-card rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto" 
                    }, [
                        React.createElement('h2', { 
                            key: 'form-title',
                            className: "text-lg font-semibold mb-4 text-blue-900" 
                        }, editingExpense ? "경비 수정" : "새 경비 추가"),
                        
                        React.createElement('form', { 
                            key: 'form',
                            onSubmit: handleSubmit,
                            className: "space-y-4" 
                        }, [
                            // 제목
                            React.createElement('div', { key: 'title-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "제목"),
                                React.createElement('input', {
                                    key: 'input',
                                    type: 'text',
                                    value: formData.title,
                                    onChange: (e) => setFormData(prev => ({ ...prev, title: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                                    placeholder: "예: 펜션 바베큐 고기값"
                                })
                            ]),

                            // 금액
                            React.createElement('div', { key: 'amount-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "금액"),
                                React.createElement('input', {
                                    key: 'input',
                                    type: 'number',
                                    value: formData.amount,
                                    onChange: (e) => setFormData(prev => ({ ...prev, amount: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                                    placeholder: "0"
                                })
                            ]),

                            // 결제자
                            React.createElement('div', { key: 'payer-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "결제자"),
                                React.createElement('select', {
                                    key: 'select',
                                    value: formData.payer,
                                    onChange: (e) => setFormData(prev => ({ ...prev, payer: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                }, members.map(member => 
                                    React.createElement('option', { 
                                        key: member,
                                        value: member 
                                    }, member === '승우' ? `🎖️ ${member}` : `🏊‍♀️ ${member}`)
                                ))
                            ]),

                            // 카테고리
                            React.createElement('div', { key: 'category-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "카테고리"),
                                React.createElement('select', {
                                    key: 'select',
                                    value: formData.category,
                                    onChange: (e) => setFormData(prev => ({ ...prev, category: e.target.value })),
                                    className: "w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                }, categories.map(category => 
                                    React.createElement('option', { 
                                        key: category.id,
                                        value: category.id 
                                    }, `${category.icon} ${category.name}`)
                                ))
                            ]),

                            // 참여자
                            React.createElement('div', { key: 'participants-field' }, [
                                React.createElement('label', { 
                                    key: 'label',
                                    className: "block text-sm font-medium text-blue-900 mb-1" 
                                }, "참여자"),
                                React.createElement('div', { 
                                    key: 'checkboxes',
                                    className: "grid grid-cols-2 gap-2" 
                                }, members.map(member => 
                                    React.createElement('label', { 
                                        key: member,
                                        className: "flex items-center gap-2 cursor-pointer" 
                                    }, [
                                        React.createElement('input', {
                                            key: 'checkbox',
                                            type: 'checkbox',
                                            checked: formData.participants.includes(member),
                                            onChange: (e) => {
                                                if (e.target.checked) {
                                                    setFormData(prev => ({
                                                        ...prev,
                                                        participants: [...prev.participants, member]
                                                    }));
                                                } else {
                                                    setFormData(prev => ({
                                                        ...prev,
                                                        participants: prev.participants.filter(p => p !== member)
                                                    }));
                                                }
                                            },
                                            className: "rounded border-blue-300 text-blue-600 focus:ring-blue-500"
                                        }),
                                        React.createElement('span', { 
                                            key: 'name',
                                            className: "text-sm text-blue-900" 
                                        }, member === '승우' ? `🎖️ ${member}` : `🏊‍♀️ ${member}`)
                                    ])
                                ))
                            ]),

                            // 버튼들
                            React.createElement('div', { 
                                key: 'buttons',
                                className: "flex gap-3 pt-4" 
                            }, [
                                React.createElement('button', {
                                    key: 'cancel',
                                    type: 'button',
                                    onClick: () => {
                                        setShowAddForm(false);
                                        setEditingExpense(null);
                                    },
                                    className: "flex-1 px-4 py-2 border border-blue-300 rounded-lg text-blue-700 hover:bg-blue-50"
                                }, "취소"),
                                React.createElement('button', {
                                    key: 'submit',
                                    type: 'submit',
                                    className: "flex-1 px-4 py-2 water-button text-white rounded-lg"
                                }, editingExpense ? "수정" : "추가")
                            ])
                        ])
                    ])
            ]);
        }

        // React 18 호환 렌더링
        const container = document.getElementById('root');
        if (typeof ReactDOM.createRoot === 'function') {
            // React 18
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(App));
        } else {
            // React 17 fallback
            ReactDOM.render(React.createElement(App), container);
        }
        }

        // React 18 호환 렌더링
        const container = document.getElementById('root');
        if (typeof ReactDOM.createRoot === 'function') {
            // React 18
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(App));
        } else {
            // React 17 fallback
            ReactDOM.render(React.createElement(App), container);
        }
    </script>
</body>
</html>
